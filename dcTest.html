<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.6.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.3/dc.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.3/dc.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.3/dc.min.js.map"></script>
    <script src="http://colorbrewer2.org/export/colorbrewer.js"></script>
    
    

    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0/dc.min.css">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <style>

    </style>

    <script>
        'use strict';
        //var yearlyBubbleChart = dc.bubbleChart('#yearly-bubble-chart');
        var locationBubbleChart = dc.bubbleChart("#location-bubble-chart");

        d3.json('data/GDX.json', function (data) {
            var dateFormat = d3.timeFormat('%m/%d/%Y');
            var numberFormat = d3.format('.2f');

            var features = data.features;
            var avg_x = 0,
                avg_y = 0,
                avg_attr = "";

            features.forEach(function (d) {
                avg_x += d.geometry.x;
                avg_y += d.geometry.y;
                avg_attr += d.attributes.COMMON;
            });


            var gdx = crossfilter(data);
            var all = gdx.groupAll();

            var attriDimension = gdx.dimension(function (d) {
                return d.attributes.COMMON;
            });



            var xDimension = gdx.dimension(function (d) {
                return d.newX = Math.round(d.geometry.x);
            });

            var yDimension = gdx.dimension(function (d) {
                return d.newY = Math.round(d.geometry.y);
            })

            var yDimensionGroup = yDimension.group().reduce(
                function (p, v) {
                    ++p.count;
                    return p;
                },
                function (p, v) {
                    --p.count;
                    return p;
                },
                function (p, v) {
                    return {
                        count: 0
                    };
                }
                );

            locationBubbleChart
            .width(1000)
            .height(250)
            .transitionDuration(1500)
            .dimension()
            .group(attriDimensionGroup)
            .colors(colorbrewer.RdYlGn[9])
            .colorDomain([-500, 500])
            .colorAccessor(function (d) {
                return d.newX;
            })
            .keyAccessor(function (p){
                return p.newX;
            })
            .valueAccessor(function (p) {
                return p.newY;
            })
            .radiusValueAccessor(function (p) {
                return p.count;
            })
            .maxBubbleRelativeSize(0.3)
            .x(d3.scale.linear().domain([-2500, 2500]))
            .y(d3.scale.linear().domain([-100, 100]))
            .r(d3.scale.linear().domain([0, 4000]))
            .elasticY(true)
            .elasticX(true)
            .yAxisPadding(100)
            .xAxisPadding(500)
            .renderHorizontalGridLines(true)
            .renderVerticalGridLines(true)
            .xAxisLabel('New X')
            .yAxisLabel('New Y')
            .renderLabel(true)
            .label(function (p) {
             return p.key;
            })
            .renderTitle(true)
            .title(function (p) {
                return [
                    p.key,
                    'Index Gain: ' + numberFormat(p.newX),
                    'Index Gain in Percentage: ' + numberFormat(p.newY) + '%',
                    'Fluctuation / Index Ratio: ' + numberFormat(p.count) + '%'
                ].join('\n');
            })
            .yAxis().tickFormat(function (v) {
                return v + '%';
            });

            //fields = [];
            //function yReduceFieldsAdd(fields) {
            //    return function (p, v) {
            //        fields.forEach(function (f) {
            //            p[f] += 1;
            //        });
            //    };
            //};

            //var fields = ["newX", "newY"];
            //function reduceFieldsAdd(fields) {
            //    return function (p, v) {
            //        fields.forEach(function (f) {
            //            p[f] += 1;
            //        });
            //        return p;
            //    };
            //};
            //function reduceFieldsRemove(fields) {
            //    return function (p, v) {
            //        fields.forEach(function (f) {
            //            p[f] -= 1;
            //        });
            //        return p;
            //    };
            //};
            //function reduceFieldsInitial(fields) {
            //    return function (p, v) {
            //        var ret = {};
            //        fields.forEach(function (f) {
            //            p[f] = 0;
            //        });
            //        return ret;
            //    };
            //};
            //var attriDimensionGroup = attriDimension.group().reduce(
            //    reduceFieldsAdd,
            //    reduceFieldsRemove,
            //    reduceFieldsInitial);

            //locationBubbleChart
            //.width(1000)
            //.height(250)
            //.transitionDuration(1500)
            //.dimension()
            //.group(attriDimensionGroup)
            //.colors(colorbrewer.RdYlGn[9])
            //.colorDomain([-500, 500])
            //.colorAccessor(function (d) {
            //    return d.value.absGain;
            //})
            //.keyAccessor(function (p){
            //    return p.value.absGain;
            //})
            //.valueAccessor(function (p) {
            //    return p.value.percentageGain;
            //})
            //.radiusValueAccessor(function (p) {
            //    return p.value.fluctuationPercentage;
            //})
            //.maxBubbleRelativeSize(0.3)
            //.x(d3.scale.linear().domain([-2500, 2500]))
            //.y(d3.scale.linear().domain([-100, 100]))
            //.r(d3.scale.linear().domain([0, 4000]))
            //.elasticY(true)
            //.elasticX(true)
            //.yAxisPadding(100)
            //.xAxisPadding(500)
            //.renderHorizontalGridLines(true)
            //.renderVerticalGridLines(true)
            //.xAxisLabel('Index Gain')
            //.yAxisLabel('Index Gain %')
            //.renderLabel(true)
            //.label(function (p) {
            // return p.key;
            //})
            //.renderTitle(true)
            //.title(function (p) {
            //    return [
            //        p.key,
            //        'Index Gain: ' + numberFormat(p.value.absGain),
            //        'Index Gain in Percentage: ' + numberFormat(p.value.percentageGain) + '%',
            //        'Fluctuation / Index Ratio: ' + numberFormat(p.value.fluctuationPercentage) + '%'
            //    ].join('\n');
            //})
            //.yAxis().tickFormat(function (v) {
            //    return v + '%';
            //});

        });


    </script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-6 col-md-4" id="location-bubble-chart">chart1</div>
        </div>
        <div class="row">
            <div class="col-xs-6 col-md-4">chart1</div>
            <div class="col-xs-6 col-md-4">chart2</div>
            <div class="col-xs-6 col-md-4">chart3</div>
        </div>
        <div class="row">
            <div class="col-xs-6 col-md-6">chart4</div>
            <div class="col-xs-6 col-md-6">chart5</div>
        </div>
    </div>

</body>
</html>