<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://code.jquery.com/jquery-3.1.1.js" integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA=" crossorigin="anonymous"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <!--<link href="css/dashboard.css" rel="stylesheet">-->

    <link rel="stylesheet" href="https://js.arcgis.com/4.3/esri/css/main.css">
    <script src="https://js.arcgis.com/4.3/"></script>

    <!--<link rel="shortcut icon" href="">-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.0.1/dc.min.js"></script>-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.0.1/dc.min.css">

    <script src="http://colorbrewer2.org/export/colorbrewer.js"></script>

    <script src="http://code.highcharts.com/highcharts.js"></script>
    <!--<script src="https://code.highcharts.com/modules/exporting.js"></script>-->
    <script src="./js/export-csv_glc.js"></script>

    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "dojo/query",
            "dojo/dom",
            "https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js",
            "https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js",
////            "http://code.highcharts.com/highcharts.js",
            "https://code.highcharts.com/modules/exporting.js",
            "./js/export-csv_glc.js",

            "dojo/domReady!"
        ], function (
            Map,
            MapView,
            FeatureLayer,
            query,
            dom
        ) {
            var watersheds = [];
            //var data = [];
            function watershedObj(name) {
                this.name = name;
                this.loads = {
                    Discharge: [],
                    SS: [],
                    TP: [],
                    DRP: [],
                    NIT: [],
                    TKN: [],
                    CHL: [],
                    TN: [],
                    PTN: [],
                    TPP: [],
                    PP:[]
                };
                this.ual = {
                    Discharge: [],
                    SS: [],
                    TP: [],
                    DRP: [],
                    NIT: [],
                    TKN: [],
                    CHL: [],
                    TN: [],
                    PTN: [],
                    TPP: [],
                    PP:[]
                };
                this.flowWeighted = {
                    Discharge: [],
                    SS: [],
                    TP: [],
                    DRP: [],
                    NIT: [],
                    TKN: [],
                    CHL: [],
                    TN: [],
                    PTN: [],
                    TPP: [],
                    PP:[]
                };
                this.timeWeighted = {
                    Discharge: [],
                    SS: [],
                    TP: [],
                    DRP: [],
                    NIT: [],
                    TKN: [],
                    CHL: [],
                    TN: [],
                    PTN: [],
                    TPP: [],
                    PP:[]
                };
                this.springLoads = {
                    Discharge: [],
                    SS: [],
                    TP: [],
                    DRP: [],
                    NIT: [],
                    TKN: [],
                    CHL: [],
                    TN: [],
                    PTN: [],
                    TPP: [],
                    PP:[]
                };
                this.springFlow = {
                    Discharge: [],
                    SS: [],
                    TP: [],
                    DRP: [],
                    NIT: [],
                    TKN: [],
                    CHL: [],
                    TN: [],
                    PTN: [],
                    TPP: [],
                    PP:[]
                };
            };
            function getWatershed(name) {
                for(var i = 0; i < watersheds.length;i++){
                    if(watersheds[i].name == name)
                        return watersheds[i];
                }
                return null;
            };
            function getWatershedNames(){
                var names = [];
                watersheds.forEach(function (d){
                    names.push(d.name);
                });
                return names;
            };

            function calculateFieldset(field) {
                switch (field) {
                    case "Loads":
                        return "loads";
                    case "Unit Area Loads":
                        return "ual";
                    case "Flow-weighted mean concentrations":
                        return "flowWeighted";
                    case "Time-weighted mean concentrations":
                        return "timeWeighted";
                    case "Spring Loads":
                        return "springLoads";
                    case "Spring Flow-weighted mean concentrations":
                        return "springFlow";
                    default:
                        return field;
                }
            };

            $.get("data/NCWQR Lake Erie Tribs GLC combined.csv", function (in_file){
                var lines = in_file.split('\n');
                var fields = lines[0].split(',');

                for(var i = 1; i < lines.length; i++){
                    var line = lines[i].split(',')
                    line[2] = parseInt(line[2]);
                    if(line[2] < 2008)
                        continue;
                    var existnames = getWatershedNames();
                    if(existnames.includes(line[0])){
                        var w = getWatershed(line[0]);
                        for(var j = 4; j < fields.length; j++){
                            w[calculateFieldset(line[3])][fields[j]].splice(parseInt(line[1]) - 2008, 0, parseFloat(lines[j]));
                        }
                    }else{
                        var newWatershed = new watershedObj(line[0]);
                        for(var j = 4; j < fields.length; j++){
                            //line = lines[i];
                            var field = line[3];
                            field =calculateFieldset(line[3]);
                            var measure = fields[j];
//                            newWatershed[calculateFieldset(lines[i][3])][fields[j]].splice(lines[i][2], 0, parseFloat(lines[i][j]));
                            newWatershed[field][measure].splice(parseInt(line[1]) - 2008, 0, parseFloat(line[j]));
                        }
                        watersheds.push(newWatershed);
                    }

                }
                var test;

            })

        });
    </script>
</head>
<body>

</body>
</html>